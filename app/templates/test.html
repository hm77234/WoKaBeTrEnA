{% extends 'base.html' %}
{% block content %}

{% if not session.test_group %}  {# First visit: Show SELECT #}
  <h1>{{ icons.test }} {{ t['test_title'] }}: {{ pair.name_title }}
    {% if selected_group != 'all' %}- {{ selected_group.title() }}{% endif %}
    ({{ status }})  BLA {{ user_pref }}
  </h1>
 
  <form method="POST" style="background:#f8f9fa; padding:30px; border-radius:12px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <h3>{{ icons.rocket }} {{ t['start_test_title'] }}</h3>

        <div style="margin:20px 0;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">
                {{ icons.group }} {{ t['group'] }}:
                <select name="group" required style="width:100%; padding:10px;">
                    {% for g in groups %}
                    <option value="{{ g }}" {{ 'selected' if g == selected_group }}>
                        {{ icons.test ~ ' ' ~ t['allwords'] if g == 'all' else g.title() }}
                    </option>
                    {% endfor %}
                </select>
            </label>
        </div>

        <div style="margin:20px 0;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">
                {{ icons.stats }} {{ t['knowledege_label'] }}:
                <select name="knowledgebase" required style="width:100%; padding:10px;">
                    {% for k,v in knowledgebase_dict.items() %}
                    <option value="{{ k }}" {{ 'selected' if k == selected_kb }}>
                        {{ v.status }}
                    </option>
                    {% endfor %}
                </select>
            </label>
        </div>

        <button type="submit" class="btn-student" style="width:100%; padding:15px; font-size:1.2em;">
            {{ icons.target }} {{ t['start_test_button'] }}
        </button>
  </form>

{% else %}

<h1>{{ icons.test }} {{ t['test_title'] }}: {{ pair.name_title }}</h1>

{% if result %}
  <div class="flash">
    {{ result }}
    {% if score_pct is not none %} ({{ '%.1f'|format(score_pct) }}%) {% endif %}
  </div>
  {% if prompt_word %}
    <p>{{ direction }}: <strong>{{ prompt_word }}</strong> → {{ target_word }}</p>
  {% endif %}
{% endif %}

<form method="POST" style="background:#f0f8ff; padding:15px; margin-bottom:20px; border-radius:8px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <label>{{ icons.group }} {{ t['group'] }}:
        <select name="group">
            {% if groups %}
                {% for g in groups %}
                <option value="{{ g }}" {{ 'selected' if g == selected_group }}>{{ g.title() }}</option>
                {% endfor %}
            {% else %}
                <option value="all" {{ 'selected' if selected_group == 'all' }}>{{ icons.test }} {{ t['allwords'] }}</option>
            {% endif %}
        </select>
    </label>

    <label style="margin-left:20px;">{{ icons.stats }} {{ t['knowledege_label'] }}:
        <select name="knowledgebase">
            {% for k,v in knowledgebase_dict.items() %}
            <option value="{{ k }}" {{ 'selected' if k == knowledgebase }}>
                {{ v.status }}
            </option>
            {% endfor %}
        </select>
    </label>

    <button type="submit" class="btn-student">
        {{ icons.change }} {{ t['change'] }}
    </button>
</form>

<form method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="word_id" value="{{ word.id }}">
    <input type="hidden" name="knowledgebase" value="{{ knowledgebase }}">
    <input type="hidden" name="group" value="{{ selected_group }}">

    <div style="font-size:2em; margin:20px 0;">
        {% if d == 'A→B' %}
            {{ word.mutter_word }} → ?
        {% else %}
            {{ word.foreign_word }} → ?
        {% endif %}
        {% if word.info %}
            <p class="word-info">{{ t['info'] }}: {{ word.info }}</p>
        {% endif %}
    </div>

    <input type="text" name="answer" autofocus style="width:100%; padding:10px; font-size:1.2em;">

    <div>
        <label>
            <input type="radio" name="direction" value="A→B" {% if d == 'A→B' %}checked{% endif %}>
            {{ mutter }} → {{ foreign }}
        </label>
        <label>
            <input type="radio" name="direction" value="B→A" {% if d == 'B→A' %}checked{% endif %}>
            {{ foreign }} → {{ mutter }}
        </label>
        <label>
            <input type="checkbox" name="random_direction" value="1" {% if rd == '1' %}checked{% endif %}>
            {{ t['random'] }}
        </label>
    </div>

    <button type="submit" class="btn-student">
        {{ icons.success }} {{ t['test'] }}
    </button>
</form>

{% endif %}

<br>
<div>
    <a href="/stats" class="btn-student">{{ icons.stats }} {{ t['stats'] }}</a>
</div>

{% endblock %}
